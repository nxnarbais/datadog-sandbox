apiVersion: v1
kind: Service
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  ports:
    - port: 80
  selector:
    app: wordpress
    tier: frontend
  type: LoadBalancer
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wp-pv-claim
  labels:
    app: wordpress
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: wordpress-configmap
  labels:
    app: wordpress
data:
  mods-enabled.status.conf: |
    # https://www.devopsschool.com/blog/how-to-install-mod_status-on-your-apache-servers-and-enable-extendedstatus/
    <IfModule mod_status.c>
      # Allow server status reports generated by mod_status,
      # with the URL of http://servername/server-status
      # Uncomment and change the "192.0.2.0/24" to allow access from other hosts.

      <Location /server-status>
        SetHandler server-status
        #Require local
        Require all granted
        #Require ip 192.0.2.0/24
      </Location>

      # Keep track of extended status information for each request
      ExtendedStatus On

      # Determine if mod_status displays the first 63 characters of a request or
      # the last 63, assuming the request itself is greater than 63 chars.
      # Default: Off
      #SeeRequestTail On


      <IfModule mod_proxy.c>
        # Show Proxy LoadBalancer status in mod_status
        ProxyStatus On
      </IfModule>


    </IfModule>

    # vim: syntax=apache ts=4 sw=4 sts=4 sr noet
  htaccess: |
    # BEGIN WordPress

    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    # https://serverfault.com/questions/466734/apache-server-status-returning-404-then-redirecting-to-my-wordpress-install
    RewriteCond %{REQUEST_URI} !=/server-status
    RewriteRule . /index.php [L]

    # END WordPress
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  labels:
    app: wordpress
    tags.datadoghq.com/env: sandbox
    tags.datadoghq.com/service: wordpress-sandbox
    tags.datadoghq.com/version: "0.0.1"
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: frontend
        tags.datadoghq.com/env: sandbox
        tags.datadoghq.com/service: wordpress-sandbox
        tags.datadoghq.com/version: "0.0.1"
      annotations:
        ad.datadoghq.com/wordpress.checks: |
          {
            "apache": {
              "init_config": {},
              "instances": [
                {
                  "apache_status_url": "http://%%host%%/server-status?auto"
                }
              ]
            }
          }
        ad.datadoghq.com/wordpress.logs: '[{"source": "wordpress","service": "wordpress-sandbox","tags": ["some_tag:some_value"]}]'
    spec:
      containers:
      - name: wordpress
        image: docker.io/library/wordpress-apm:latest
        imagePullPolicy: Never
        env:
        - name: WORDPRESS_DB_HOST
          value: wordpress-mysql
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        - name: WORDPRESS_DB_USER
          value: wordpress
        - name: DD_ENV
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/env']
        - name: DD_SERVICE
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/service']
        - name: DD_VERSION
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['tags.datadoghq.com/version']
        - name: DD_PROFILING_ENABLED
          value: "true"
        - name: DD_TRACE_SAMPLE_RATE
          value: "1"
        - name: DD_SERVICE_MAPPING
          value: "mysqli:wordpress-sandbox-mysqli,curl:wordpress-sandbox-curl,redis:wordpress-sandbox-redis,memcached:wordpress-sandbox-memcached,mysql:wordpress-sandbox-mysql,http:wordpress-sandbox-http,apache:wordpress-sandbox-apache"
        - name: DD_LOGS_INJECTION
          value: "1"
        - name: DD_TAGS
          value: "team:wordpress,platform:ecommerce"
        ports:
        - containerPort: 80
          name: wordpress
        volumeMounts:
        - name: wordpress-persistent-storage
          mountPath: /var/www/html
        - name: wordpress-configmap-vol
          mountPath: "/etc/apache2/mods-enabled/status.conf"
          subPath: "status.conf"
        - name: wordpress-configmap-htaccess-vol
          mountPath: "/var/www/html/.htaccess"
          subPath: ".htaccess"
        - name: apmsocketpath
          mountPath: /var/run/datadog
      volumes:
      - name: wordpress-persistent-storage
        persistentVolumeClaim:
          claimName: wp-pv-claim
      - name: wordpress-configmap-vol
        configMap:
          # Provide the name of the ConfigMap you want to mount.
          name: wordpress-configmap
          # An array of keys from the ConfigMap to create as files
          items:
          - key: "mods-enabled.status.conf"
            path: "status.conf"
      - name: wordpress-configmap-htaccess-vol
        configMap:
          name: wordpress-configmap
          items:
          - key: "htaccess"
            path: ".htaccess"
      - name: apmsocketpath
        hostPath:
          path: /var/run/datadog/
        
